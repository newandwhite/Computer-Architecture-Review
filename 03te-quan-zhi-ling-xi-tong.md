# 03 特权指令系统
### 特权指令系统简介
现代计算机的指令系统在用户态子集之外还定义了操作系统核心专用的特权态部分
*为了让计算机变得更好用、更安全*
机制分类：
* 运行模式定义及其转换
* 虚拟存储管理
* 异常与中断处理
* 控制状态寄存器

### 异常与中断
#### 异常
* 异常分类
    * 外部事件：来自CPU核外部的事件，即中断。软件不可控制
        * 健全的软硬件机制来防止中断对正常执行流带来影响
    * 指令执行中的错误：执行中指令的操作码或操作数不符合要求
        * 转到出错处进行处理
    * 数据完整性问题：使用ECC等硬件校验方式的存储器发生校验错误
        * 可纠正的错误可用于统计硬件的风险
        * 不可纠正的错误则应视出错位置进行相应处理
    * 地址转换异常：在存储管理单元需要对一个内存页进行地址转换，而硬件转换表中没有有效的转换对应项可用时（TLB refill）
    * 系统调用和陷入：由专有指令产生，产生操作系统可识别的异常，用于在保护模式下调用核心态的相关操作
    * 需要软件修正的运算：某些操作和操作数的组合硬件由于实现过于复杂而不愿意处理，寻求软件帮助
* 异常处理
    1. 异常处理准备
    2. 确定异常来源
    3. 保存执行状态
    4. 处理异常
    5. 恢复执行状态并返回正常执行流

#### 中断
* 可屏蔽和不可屏蔽中断
* 中断优先级
    * 非向量中断模式：处理器通常不区别中断的优先级。此时若需要对中断进行优先级处理，可以通过软件方式予以实现
        * 软件随时维护一个中断优先级（IPL），每个中断源都被赋予特定的优先级
        * 正常状态下，CPU运行在最低优先级，此时任何中断都可触发
        * 当处于最高中断优先级时，任何中断都被禁止
        * 更高优先级的中断发生时，可以抢占低优先级的中断处理过程
    * 采用向量中断模式时，依照一套既定的优先级规则来从多个已生效的中断源中选择一个，跳转到其对应的处理程序入口处
* 中断传递机制
    * **中断线**：当系统中断源不多时，直接连到处理器引脚即可。若中断源较多，可使用中断控制器汇总后再与处理器引脚相连
        * 扩展性不够强
        * 有较强延迟
    * 消息中断**MSI**：消息中断以数据的方式在总线上传递。发中断就是向指定的地址写一个指定的数
        * 数据包
        * 中断包
    
### 存储管理
* 虚拟存储管理
    * 存储管理作用
        * 隐藏和保护
        * 为程序分配连续内存空间
        * 扩展地址空间
        * 节约物理内存
    * 页式存储管理
        * 核心部件是TLB
    * 地址转换和TLB
    
**计算有多少是TLB无效例外和多少次重填例外（找不到地址转换）？**

* LoongArch：处理器对虚存系统的支持
* LINUX操作系统的存储管理：
 ```
 array=(int*)malloc(0x1000); 
 for (i=0;i<1024;i++) 
     array[i] = 0;
 ```
* TLB的性能分析和优化
