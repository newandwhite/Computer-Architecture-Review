# 02 指令系统
指令系统是软硬件交互的界面

CPU（主语）
操作（谓语）
操作对象/操作数（宾语）

### 设计原则
* 兼容性：向前兼容，指令可加不可减
* 通用性
* 高效性
* 安全性

### 指令系统演变
* 指令集分类
    * CISC（复杂指令系统）：指令长度可变
    * RISC（精简指令系统）：指令长度比较固定，简化指令间关系
        * 简化了指令功能，单个指令执行周期短
        * 简化了指令编码，使得译码简单
        * 简化访存类型，访存只能通过load/store指令实现
    
    有利于实现高效流水线、多发射技术，从而提高主频和效率
    * VLIW（超长指令字）：本质上是多条同时执行指令的组合，最大限度利用指令间并行
* 存储管理
    * 连续实地址：各程序所需的内存空间必须连续存放并保证不与其他程序产生冲突
        * 会带来大量内存碎片，而且难以管理多个程序的空间分配
    * 段式：将内存分为多个段和节，地址组织为相对于段地址的偏移
    * 页式：将各进程的虚拟内存空间划分成若干长度相同的页，将虚拟地址和物理地址的对应关系组织为页表，并通过硬件来实现快速的地址转换
    > 段式、页式、段页式
* 运行级别
    * 用户态：程序只能访问受限的内存空间，不允许访问外围设备（看不到Cache和TLB）
    * 核心态：具有最高权限，可以执行所有指令
    
    用户态程序需要使用外围设备时，通过系统调用提出申请，由操作系统在核心态下完成访问
    
### 指令系统组成
* 地址空间
    * 处理器可访问地址空间包括（对操作对象进行分类）：立即数、寄存器空间（通用寄存器、专用寄存器和控制寄存器，通过编码于指令中的寄存器号寻址）、系统内存空间（通过访存指令中的访存地址寻址）
    * 根据指令使用数据方式，指令系统可分为：
        * 堆栈型：操作数都在栈顶，在运算指令中不需要指定操作数，默认对栈顶数据进行运算并将结果压回栈顶
        ```
        PUSH A
        PUSH B
        ADD
        POP C
        ```
        * 累加器型：包含一个隐藏操作数--累加器，另一个操作数在指令中指定，结果写回累加器中
        ```
        LOAD A
        ADD B
        STORE C
        ```
        * 寄存器型（当今指令系统主要）
            * 寄存器-寄存器型：每个操作数都由指令显式指令，操作数为寄存器和内存单元
            ```
            LOAD R1, A
            ADD R1, B
            STORE C, R
            ```
            * 寄存器-存储器型：每个操作数都由指令显式指令，但除了访存指令外的其他指令的操作数都只能是寄存器
            ```
            LOAD R1, A
            LOAD R2, B
            ADD R3, R1, R2
            STORE C, R3
            ```
* 操作数
    * 操作数的存储
        * 访存地址是否对齐、指令系统是否支持不对齐访问
        * 大小尾端：最高有效字节的地址较小的是大尾端
        * 寻址方式：偏移量寻址、立即数寻址、寄存器间接寻址……
    > * 操作数的特征
* 指令操作和编码（现代操作系统指令功能由指令操作码决定）
    * 运算指令
    * 访存指令
    * 转移指令（转移条件、转移目标地址）
        * 条件转移 & 无条件转移
        * 过程调用 & 过程返回
    * 系统管理指令（操作系统内核用）

### RISC 指令集比较
RISC指令的历史：
* RISC I-V
* ARM
* LoongArch

### C语言的机器表示
e.g.一段不断递归调用的程序，实际能跑的次数不一定等于调用次数，因为内存堆栈（静态数据动态数据：从上往下涨）会溢出