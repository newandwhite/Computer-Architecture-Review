# 07 计算机系统启动过程分析
### 处理器核初始化
* 第一条指令从哪里取的？什么时候把内核拷贝到内存？

无论采用何种指令系统的处理器，复位后的第一条指令都会从一个预先定义的特定地址取回
对于LoongArch，处理器复位后的第一条指令将固定从地址0x1C000000 的位置获取。这个地址需要对应一个能够给处理器核提供指令的设备，这个设备以前是各种ROM，现在通常是闪存（Flash）

处理器的启动过程，实际上就是一个特定程序的执行过程。这个程序我们称之为固件，又称为BIOS（基本输入输出系统）【程序计数器到BIOS】

BIOS启动后，完成初始化，将操作系统程序从内核拷贝到内存

* 处理器复位
![](/pic/处理器复位.jpg)
* 调试接口初始化
* TLB初始化：主要是将全部表项初始化为无效项（每项逐一清空）
* Cache初始化：Cache组织结构主要包含Tag和Data两个部分。大多数情况下就是对Tag的初始化，将其中Cache块状态设为无效
    * 操作什么cache分为Icache、Dcache、L2和L3四类
    * 什么操作，分为index无效、hit无效、写tag等

### 总线接口初始化
* 内存初始化：根据内存配置信息对内存控制器进行初始化。
    * 与Cache初始化类似的是，内存初始化并不涉及其存储的初始数据。
    * 与Cache初始化不同的是，Cache有专门的硬件控制位来表示Cache块是否有效，而内存却并不需要这样的硬件控制位。
        * 内存的使用完全是由软件控制的，软件知道其访问的每一个地址是否存在有效的数据。内存初始化仅仅需要对内存控制器进行初始化，并通过**内存控制器**对内存的状态进行初始化
        
        内存控制器初始化：
            * 根据内存的行地址、列地址等对内存地址映射进行配置
            * 根据协议对内存信号调整的支持方式对内存读写信号相关的寄存器进行训练，以保证传输时的数据完整性
        * Cache 是一个硬件加速部件，大多数情况下软件并不需要真正知道而且也不希望知道其存在，Cache 的硬件控制位正是为了掩盖内存访问延迟，保证访存操作的正确性
    
    在内存初始化完成后，可能还需要根据内存的大小对系统可用的物理地址空间进行相应的调整和设置。完成后，如果是休眠唤醒，程序可以使用内存中已有的数据来恢复系统状态；如果是普通开机，则程序可以完全不关心内存数据而随意使用。
* IO总线初始化
    * 对IO总线的访问地址空间进行设置，划定设备的配置访问空间、IO访问空间和Memory访问空间
    * 对IO设备的DMA访问空间进行规定，对处理器能接收的DMA内存地址进行设置
    * 对HT总线进行升频，并扩展总线宽度

### 设备探测及驱动加载
* IO系统空间：
    * 配置空间：存储设备基本信息，主要用于设备探测和发现
    * IO空间：空间较小，用于少量设备寄存访问
    * Memory空间：空间可映射区域较大，可以方便地映射设备所需要的大块物理地址空间
    > X86分为三个空间，RISCV的IO和Memory是一个空间
* PCI设备的探测：一个递归调用的过程
    1. 将初始总线号、初始设备号、初始功能号设为0
    2. 使用当前的总线号、设备号、功能号组成一个配置空间地址，使用该地址，访问其0号寄存器，检查其设备号。
    3. 如果读出全1或全0，表示无设备
    4. 如果该设备为有效设备，检查每个 BAR 所需的空间大小，并收集相关信息
    5. 检测其是否为一个多功能设备，如果是则将功能号加1再重复扫描，执行第2步
    6. 如果该设备为桥设备，则给该桥配置一个新的总线号，再使用该总线号，从设备号0、功能号0开始递归调用，执行第2步。
    7. 如果设备号非31，则设备号加1，继续执行第2步；如果设备号为31，且总线号为0，表示扫描结束，如果总线号非0，则退回上一层递归调用
    
### 多核启动过程
* 初始化时多核协同
    * BIOS启动时，轮询实现其他设备协同
    * 主核除了对本处理器核进行初始化外，还要负责对各种总线及外设进行初始化；而从核只需要对本处理器核的私有部件进行初始化（如，核内私有寄存器、TLB、私有Cache等）
* 操作系统启动时多核唤醒
    * 主核在各种数据结构准备好的情况下就可以开始依次唤醒每一个从核，唤醒从核后主核进入等待过程，直到从核执行完毕通知主核，再唤醒一个新的从核
    * 唤醒过程是串行的
* 核间同步与通信：**核间中断**
    * 利用一组IO寄存器实现：目标核核间中断寄存器置1来产生一个中断信号，使目标核进入中断处理