# 11 多核处理结构
### 多核处理器的发展演化
* 分类：通用/专用、同构/异构、多核/众核

### 多核处理器的访存结构
* 片上Cache结构：私有、片上共享、片间共享
    * 主流Cache结构：LLC（片内共享最后一级Cache），片间共享内存
    > 典型商用：一级和二级Cache私有，三级Cache
    
        * UCA：集中式共享结构，多个处理器核通过总线或者交叉开关连接LLC，所有处理器核对LLC的访问延迟相同
            * 可扩展性受限
        * NUCA：一种分布式共享结构，每个处理器有本地LLC，并通过片上互联访问其他处理器核LLC
            * 通常采用可扩展的片上互联，采用基于目录的Cache一致性协议，具有良好的可扩展性
* 存储一致性模型：
    * 顺序一致性SC
    * 处理器一致性PC：比顺序一致性模型弱
    * 弱一致性WC：把同步操作和普通访存操作区分开
    * 释放一致性RC：把同步操作进一步分成获取操作acquire和释放操作release
* Cache一致性协议：
    * 新值会传播给谁的角度：目录协议/侦听协议
    * 如何传播新值的角度：write-invalidate写无效协议/write-update写更新协议
    
    Cache一致性协议实现方式为：在Cache中每一行设置一致性状态来记录该Cache行读写状态
        * 三状态ESI（E独占、S共享、I无效）
        * MESI（增加Modify状态）
        * MOESI

### 多核处理器的互连结构
* 片上总线
    * 实现简单，但可伸缩性不好，独占式资源
* 交叉开关：一个以矩阵形式组织的开关集合
    * 非阻塞，高带宽，但物理实现代价高
* 片上网络
    * 拓扑结构：环、网格
    * 路由算法：数据包从源节点到目的节点的传输路径
    * 路由器结构
    * 流量控制：用来组织每个处理器节点值有限的共享资源
        * 片上网络主要资源就是**信道**（传输节点中的数据包）和**缓冲区**（节点上的存储装置）

### 多核处理器的同步机制
* 原子操作
* 锁同步
* 栅障同步
* 事务内存
    * 事务：原子性、一致性、隔离性
    * 实现关键：冲突检测、冲突解决以及事务的提交和放弃
* “读-改-写”指令
* “LL/SC”指令

### 典型多核处理器